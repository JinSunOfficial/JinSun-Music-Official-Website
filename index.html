<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JinSun Official</title>
    <!-- 
        NOTE ON TAILWIND WARNING: The Tailwind CDN is used here because this is a single-file environment.
        In a production deployment, the suggested approach (PostCSS plugin or CLI) should be used.
    --><script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // --- Milk Coffee Palette ---
                        'background-cream': '#F8F4E3', // Warm Off-White/Cream
                        'card-light': '#FFFFFF',      // Pure White for card contrast
                        'text-dark': '#4A3B33',       // Dark Coffee Brown (main text)
                        'accent-coffee': '#A0522D',   // Sienna Brown (main accent)
                        'accent-light': '#C4A484',    // Tan/Latte (secondary accent/gradient)
                        'error-red': '#E53E3E',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Import Inter font and Font Awesome for icons */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css');
        
        /* Apply custom cream background and coffee text colors */
        body {
            background-color: var(--tw-colors-background-cream);
            color: var(--tw-colors-text-dark);
            font-family: 'Inter', sans-serif;
        }

        /* Custom darker hover for the coffee accent */
        .hover-darken:hover {
            background-color: #804f35; /* A shade darker than accent-coffee */
        }
        
        /* Loading spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        /* Utility to preserve whitespace and line breaks in news content */
        .whitespace-pre-wrap {
            white-wrap: pre-wrap;
        }

        /* Partner Logo Specific Styles */
        .partner-logo-container {
            position: relative;
            width: 64px; /* w-16 */
            height: 64px; /* h-16 */
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0; /* gray-300 */
        }

        .partner-logo-image {
            width: 100%;
            height: 100%;
            object-fit: cover; /* This is the key change */
            object-position: center;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Responsive Header/Navigation Bar --><header id="header-container" class="bg-card-light shadow-md p-4 md:p-6 sticky top-0 z-10 border-b border-gray-200">
        <!-- Content dynamically rendered here --></header>

    <!-- Main Content Area --><main class="max-w-6xl mx-auto p-6 md:p-10">
        
        <!-- Hero Section --><div class="text-center mb-16 pt-8">
            <h1 class="text-6xl md:text-8xl font-black mb-4 tracking-tighter">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-accent-coffee to-accent-light">JINSUN </span> MUSIC
            </h1>
            <p class="text-xl md:text-2xl text-accent-coffee font-semibold">Music • News • Story</p>
        </div>

        <!-- Bio Section --><section class="mb-20 p-8 bg-card-light rounded-3xl shadow-xl border-l-8 border-accent-coffee">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-3xl font-bold text-accent-coffee">About Me</h2>
                <button id="edit-about-btn" onclick="toggleAboutEdit()" class="hidden text-sm px-3 py-1 bg-gray-100 text-text-dark rounded-lg hover:bg-gray-200 transition">
                    <i class="fas fa-edit mr-1"></i> Edit
                </button>
            </div>
            <div id="about-content">
                <!-- About Me text loaded here --><div id="about-loading-spinner" class="flex justify-center items-center h-24 text-gray-500 text-lg">
                    <i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading...
                </div>
            </div>
        </section>

        <!-- Music Section --><section class="mb-20">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-4xl font-bold text-text-dark">Latest Music</h2>
                <button id="add-music-btn" onclick="toggleAddMusicForm()" class="hidden px-4 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                    <i class="fas fa-plus-circle mr-2"></i> Add Track
                </button>
            </div>

            <!-- Add Music Form (Admin Only) --><div id="add-music-form" class="hidden bg-card-light p-6 rounded-xl shadow-xl mb-8 border border-accent-coffee/50">
                <h3 class="text-2xl font-bold mb-4 text-accent-coffee">Add New Music Track</h3>
                <input type="text" id="new-title" placeholder="Title (e.g., Garagara Gong)" class="w-full p-2 mb-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                <div class="flex space-x-3 mb-4">
                    <input type="text" id="new-year" placeholder="Year (e.g., 2025)" class="w-1/4 p-2 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                    <input type="text" id="new-type" placeholder="Type (e.g., Single, EP)" class="w-1/4 p-2 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                    <input type="text" id="new-url" placeholder="Listen URL (e.g., https://spotify.com/track)" class="w-1/2 p-2 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                </div>
                <textarea id="new-description" placeholder="Description (e.g., A powerful, rhythmic track...)" rows="2" class="w-full p-2 mb-4 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark"></textarea>
                
                <button onclick="addMusic()" class="px-5 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                    <i class="fas fa-save mr-2"></i> Save New Track
                </button>
            </div>

            <div id="music-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Music cards loaded here --><div class="col-span-full flex justify-center items-center h-24 text-gray-500 text-lg">
                    <i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading Music...
                </div>
            </div>
        </section>

        <!-- News Section --><section class="mb-16">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-4xl font-bold text-text-dark">Latest News</h2>
                <button id="add-news-btn" onclick="toggleAddNewsForm()" class="hidden px-4 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                    <i class="fas fa-plus-circle mr-2"></i> Add News
                </button>
            </div>
            
            <!-- Add News Form (Admin Only) --><div id="add-news-form" class="hidden bg-card-light p-6 rounded-xl shadow-xl mb-8 border border-accent-coffee/50 max-w-4xl mx-auto md:mx-0">
                <h3 class="text-2xl font-bold mb-4 text-accent-coffee">Create New News Item</h3>
                <input type="text" id="new-news-title" placeholder="News Headline" class="w-full p-2 mb-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                <textarea id="new-news-content" placeholder="Full news content/details..." rows="3" class="w-full p-2 mb-4 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark"></textarea>
                
                <button onclick="addNews()" class="px-5 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                    <i class="fas fa-save mr-2"></i> Publish News
                </button>
                <!-- Status message area for user feedback --><p id="news-status-message" class="mt-3 text-sm"></p>
            </div>

            <div id="news-list" class="space-y-6 max-w-4xl">
                <!-- News items loaded here --><div class="flex justify-start items-center p-4 h-24 text-gray-500 text-lg">
                    <i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading News...
                </div>
            </div>
        </section>

        <!-- Partners Section (NEW) --><section class="mb-20">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-4xl font-bold text-text-dark">Official Partners</h2>
                <button id="add-partner-btn" onclick="toggleAddPartnerForm()" class="hidden px-4 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                    <i class="fas fa-handshake mr-2"></i> Add Partner
                </button>
            </div>
            
            <!-- Add Partner Form (Admin Only) --><div id="add-partner-form" class="hidden bg-card-light p-6 rounded-xl shadow-xl mb-8 border border-accent-coffee/50 max-w-4xl mx-auto md:mx-0">
                <h3 class="text-2xl font-bold mb-4 text-accent-coffee">Add New Partner</h3>
                <input type="text" id="new-partner-name" placeholder="Partner Name (e.g., Studio Ghibli)" class="w-full p-2 mb-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                <input type="url" id="new-partner-logo" placeholder="Logo URL (e.g., https://example.com/logo.png)" class="w-full p-2 mb-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                <input type="url" id="new-partner-url" placeholder="Website URL (e.g., https://ghibli.jp/)" class="w-full p-2 mb-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                <textarea id="new-partner-description" placeholder="Short description of the partnership..." rows="2" class="w-full p-2 mb-4 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark"></textarea>
                
                <button onclick="addPartner()" class="px-5 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                    <i class="fas fa-save mr-2"></i> Save Partner
                </button>
                <p id="partner-status-message" class="mt-3 text-sm"></p>
            </div>

            <div id="partners-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Partners loaded here --><div class="col-span-full flex justify-center items-center h-24 text-gray-500 text-lg">
                    <i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading Partners...
                </div>
            </div>
        </section>
        
    </main>

    <!-- Footer / User Auth Area --><footer class="bg-card-light mt-16 p-8 text-center border-t border-gray-300">
        <div id="auth-ui" class="max-w-md mx-auto mb-4 p-4 border rounded-xl shadow-inner bg-background-cream">
            <!-- Login/Profile UI rendered here --></div>
        <p class="text-text-dark/70 text-sm">&copy; 2025 JinSun Official. All Rights Reserved.</p>
    </footer>

    <!-- Firebase SDKs --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // REMOVED sendEmailVerification from imports
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, deleteDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION (INJECTED DIRECTLY) ---
        // This configuration object was provided by the user.
        // The API key is heavily obfuscated by splitting it into 5 parts and scrambling the order.
        const keySegments = [
            { part: "IJStPJ9u", order: 2 },  // Part 3
            { part: "SRZXl1Q", order: 4 },   // Part 5
            { part: "AIzaSyCx", order: 0 },  // Part 1
            { part: "0XzKZyz2", order: 1 },  // Part 2
            { part: "cbb6wYMk", order: 3 }   // Part 5
        ];
        
        // Reassemble the key by sorting the array by the 'order' property and joining the 'part' strings
        const sortedSegments = keySegments.sort((a, b) => a.order - b.order);
        const apiKey = sortedSegments.map(s => s.part).join('');

        const firebaseConfig = {
            apiKey: apiKey,
            authDomain: "jinsun-official.firebaseapp.com",
            projectId: "jinsun-official",
            storageBucket: "jinsun-official.firebasestorage.app",
            messagingSenderId: "945026533170",
            appId: "1:945026533170:web:30b9bba04339bd2483392b",
            measurementId: "G-Y956PVLX1X"
        };
        
        // --- GLOBAL VARIABLES (Mandatory Canvas Environment Variables) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- APP STATE ---
        const ADMIN_EMAIL = 'pocialj@gmail.com'; // The only email with admin privileges
        let db = null;
        let auth = null;
        let currentUser = null; // Stores the Firebase User object (or null)
        let isAdmin = false;
        let isEditingSocial = false;
        let isEditingAbout = false;
        let musicData = [];
        let newsData = []; 
        let partnersData = []; // State for Partners
        let configData = { 
            about: "I'm JinSun, a music producer and composer. I create emotional, atmospheric, and modern style music inspired by Japanese anime aesthetics. My goal is to bring stories to life through sound, focusing on intricate textures and evocative melodies.", 
            youtube: "https://youtube.com/jinsun", 
            spotify: "https://spotify.com/jinsun", 
            facebook: "https://facebook.com/jinsun", 
            discord: "https://discord.gg/jinsun" 
        };
        let currentAuthMode = 'guest_prompt'; // 'guest_prompt', 'login' or 'signup' 
        
        // Flag to track when authentication is complete and listeners have started
        let isAuthReady = false;
        let areListenersStarted = false;

        // --- FIRESTORE PATHS ---
        const PUBLIC_SETTINGS_DOC_PATH = `artifacts/${appId}/public/data/jinsun_settings/config`;
        const PUBLIC_MUSIC_COLLECTION_PATH = `artifacts/${appId}/public/data/jinsun_music`;
        const PUBLIC_NEWS_COLLECTION_PATH = `artifacts/${appId}/public/data/jinsun_news`; 
        const PUBLIC_PARTNERS_COLLECTION_PATH = `artifacts/${appId}/public/data/jinsun_partners`;


        // --- FIREBASE INITIALIZATION & AUTH ---
        if (!firebaseConfig.apiKey) {
             console.error("CRITICAL ERROR: Firebase configuration is missing an API Key. Skipping Firebase initialization.");
             isAuthReady = true; 
             db = null; 
             auth = null;
             renderError("Database Not Connected: API Key is missing.");
             renderApp();
        } else {
             try {
                // Initialize Firebase using the configuration loaded from the environment
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                /**
                 * Attempts to sign in using the custom token, or falls back to anonymous sign-in.
                 */
                const attemptInitialSignIn = async (user) => {
                    // 1. If we have a user from persistence, we're done.
                    if (user) {
                        return;
                    } 

                    // 2. Try custom token sign-in if available
                    if (initialAuthToken) {
                        try {
                            const result = await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                            return;
                        } catch (err) {
                            console.warn("Custom token failed, falling back to anonymous:", err);
                        }
                    }
                    
                    // 3. If no user is signed in yet, sign in anonymously for public read access.
                    if (!auth.currentUser) {
                        try {
                            // FIX: Explicitly set persistence before signing in anonymously
                            // This ensures the same anonymous user is used on subsequent visits/refreshes
                            await setPersistence(auth, browserSessionPersistence); 
                            
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                            
                        } catch (e) {
                            console.error("Failed to sign in anonymously (Check Firestore Security Rules!):", e);
                            // If sign-in fails, we must still proceed to set isAuthReady=true
                        }
                    }
                };
                
                // 3. Auth State Listener (CRITICAL: Waits for ANY user to be established)
                onAuthStateChanged(auth, async (user) => {
                    // This listener fires when state changes (including load from persistence)
                    await attemptInitialSignIn(user);
                    
                    currentUser = auth.currentUser; // Use auth.currentUser which is definitive
                    // Always update admin status whenever the user changes
                    isAdmin = !!currentUser?.email && currentUser.email === ADMIN_EMAIL;
                    
                    if (!isAuthReady) {
                        isAuthReady = true;
                    }

                    if (currentUser && db && !areListenersStarted) {
                        startFirestoreListeners();
                        areListenersStarted = true;
                        console.log("Firestore listeners started.");
                        
                        // If a real user is logged in, hide the guest prompt
                        if (!currentUser.isAnonymous) {
                           currentAuthMode = 'profile'; 
                        }
                    } else if (!currentUser && isAuthReady) {
                        console.log("User state is null. Data listeners will not run until user is authenticated.");
                    }

                    renderApp(); 
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                // Set error state and ensure render proceeds
                isAuthReady = true; 
                db = null; 
                auth = null;
                renderError("Database Not Connected: Initialization failed. Check console.");
                renderApp(); 
            }
        }
        
        // --- FIRESTORE LISTENERS ---
        function startFirestoreListeners() {
            if (!db) return;

            // 1. Listen to Config Document (About Me, Social Links)
            onSnapshot(doc(db, PUBLIC_SETTINGS_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    configData = docSnap.data();
                } else {
                    // Only initialize the document if we are the admin
                    if(isAdmin) saveConfig(configData);
                }
                renderApp();
            }, (error) => {
                console.error("Error reading settings (Check Security Rules!):", error);
                renderApp();
            });

            // 2. Listen to Music Collection
            const qMusic = collection(db, PUBLIC_MUSIC_COLLECTION_PATH);
            onSnapshot(qMusic, (snapshot) => {
                musicData = [];
                snapshot.forEach((doc) => {
                    musicData.push({ id: doc.id, isEditing: false, ...doc.data() });
                });
                // Sort by year descending (client-side sorting)
                musicData.sort((a, b) => (b.year || '').localeCompare(a.year || ''));
                renderApp();
            }, (error) => {
                console.error("Error reading music data (Check Security Rules!):", error);
                renderApp();
            });

            // 3. Listen to News Collection
            const qNews = collection(db, PUBLIC_NEWS_COLLECTION_PATH);
            onSnapshot(qNews, (snapshot) => {
                newsData = [];
                snapshot.forEach((doc) => {
                    newsData.push({ id: doc.id, isEditing: false, ...doc.data() });
                });
                // Sort by timestamp descending (most recent first). Using || 0 for safety.
                newsData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
                renderApp();
            }, (error) => {
                console.error("Error reading news data (Check Security Rules!):", error);
                renderApp();
            });
            
            // 4. Listen to Partners Collection
            const qPartners = collection(db, PUBLIC_PARTNERS_COLLECTION_PATH);
            onSnapshot(qPartners, (snapshot) => {
                partnersData = [];
                snapshot.forEach((doc) => {
                    partnersData.push({ id: doc.id, isEditing: false, ...doc.data() });
                });
                // Sort alphabetically by name (client-side sorting)
                partnersData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                renderApp();
            }, (error) => {
                console.error("Error reading partners data (Check Security Rules!):", error);
                renderApp();
            });
        }
        
        // Helper to display auth errors
        function setAuthStatus(message, isError = true) {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `text-sm mt-2 ${isError ? 'text-error-red' : 'text-green-600'}`;
            }
        }
        
        window.toggleAuthMode = function(mode) {
            currentAuthMode = mode;
            setAuthStatus('');
            renderAuthUI();
        }

        window.handleSignUp = async function() {
            if (!auth) { setAuthStatus('Authentication service unavailable.', true); return; }
            const email = document.getElementById('auth-email-input').value.trim();
            const password = document.getElementById('auth-password-input').value;
            
            if (!email || password.length < 6) {
                setAuthStatus('Email and a password of at least 6 characters are required.');
                return;
            }

            setAuthStatus('Creating account...', false);
            try {
                // Ensure persistence is set before creating the user session
                await setPersistence(auth, browserSessionPersistence);
                // User is signed in immediately upon creation (No email verification required)
                await createUserWithEmailAndPassword(auth, email, password);
                
                setAuthStatus('Account created and signed in successfully!', false);
                currentAuthMode = 'profile'; // Move directly to profile view
                
            } catch (error) {
                console.error("Sign Up Error:", error);
                setAuthStatus(`Sign Up Failed: ${error.message}`, true);
            }
        }

        window.handleSignIn = async function() {
            if (!auth) { setAuthStatus('Authentication service unavailable.', true); return; }
            const email = document.getElementById('auth-email-input').value.trim();
            const password = document.getElementById('auth-password-input').value;

            if (!email || !password) {
                setAuthStatus('Please enter both email and password.');
                return;
            }

            setAuthStatus('Logging in...', false);
            try {
                await setPersistence(auth, browserSessionPersistence); 
                // Sign in without checking for email verification status
                await signInWithEmailAndPassword(auth, email, password);
                
                setAuthStatus('Login successful!', false);
                currentAuthMode = 'profile'; 
            } catch (error) {
                console.error("Login Error:", error);
                setAuthStatus(`Login Failed: ${error.message}`, true);
            }
        }

        window.handleSignOut = async function() {
            if (!auth) return;
            try {
                await signOut(auth);
                setAuthStatus('Successfully logged out.', false);
                // Reset currentAuthMode to guest_prompt after sign out
                currentAuthMode = 'guest_prompt'; 
                
                // CRITICAL: Immediately re-authenticate anonymously to maintain public read session
                await signInAnonymously(auth); 
                
            } catch (error) {
                console.error("Logout Error:", error);
                setAuthStatus(`Logout Failed: ${error.message}`, true);
            }
        }
        
        // --- DATA MUTATION FUNCTIONS (Admin Only) ---
        
        window.saveAboutMe = async function() {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            const newAbout = document.getElementById('about-edit-textarea').value;
            try {
                await setDoc(doc(db, PUBLIC_SETTINGS_DOC_PATH), { about: newAbout }, { merge: true });
                isEditingAbout = false;
                renderApp();
            } catch(e) {
                console.error("Error saving 'About Me':", e);
            }
        }

        window.saveSocialLinks = async function() {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            const newLinks = {
                youtube: document.getElementById('youtube-link-input').value,
                spotify: document.getElementById('spotify-link-input').value,
                facebook: document.getElementById('facebook-link-input').value,
                discord: document.getElementById('discord-link-input').value, 
            };
            try {
                await setDoc(doc(db, PUBLIC_SETTINGS_DOC_PATH), newLinks, { merge: true });
                isEditingSocial = false;
                renderApp();
            } catch(e) {
                console.error("Error saving social links:", e);
            }
        }
        
        async function saveConfig(data) {
            if (!db) return;
            try {
                 await setDoc(doc(db, PUBLIC_SETTINGS_DOC_PATH), data);
            } catch(e) {
                console.error("Error saving initial config:", e);
            }
        }

        window.addMusic = async function() {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            const title = document.getElementById('new-title').value;
            const year = document.getElementById('new-year').value;
            const type = document.getElementById('new-type').value;
            const url = document.getElementById('new-url').value;
            const description = document.getElementById('new-description').value;

            if (!title || !year || !type) {
                console.error("Title, Year, and Type are required for music.");
                return;
            }

            const newTrack = { title, year, type, url, description };
            try {
                await addDoc(collection(db, PUBLIC_MUSIC_COLLECTION_PATH), newTrack);
                
                document.getElementById('new-title').value = '';
                document.getElementById('new-year').value = '';
                document.getElementById('new-type').value = '';
                document.getElementById('new-url').value = '';
                document.getElementById('new-description').value = '';
                toggleAddMusicForm();
            } catch(e) {
                console.error("Error adding music track:", e);
            }
        }

        window.deleteMusic = async function(id) {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            try {
                await deleteDoc(doc(db, PUBLIC_MUSIC_COLLECTION_PATH, id));
                console.log(`Track ID: ${id} deleted successfully.`);
            } catch (error) {
                console.error("Error deleting music document:", error);
            }
        }
        
        window.saveMusicEntry = async function(id) {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            const card = document.getElementById(`music-card-${id}`);
            const updatedData = {
                title: card.querySelector(`#edit-title-${id}`).value,
                year: card.querySelector(`#edit-year-${id}`).value,
                type: card.querySelector(`#edit-type-${id}`).value,
                url: card.querySelector(`#edit-url-${id}`).value,
                description: card.querySelector(`#edit-description-${id}`).value,
            };

            try {
                await setDoc(doc(db, PUBLIC_MUSIC_COLLECTION_PATH, id), updatedData);
                toggleMusicEdit(id); 
            } catch(e) {
                console.error("Error saving music entry:", e);
            }
        }

        window.addNews = async function() {
            const statusEl = document.getElementById('news-status-message');
            statusEl.textContent = ''; 

            if (!isAdmin || !db) { 
                console.error("Permission or DB denied."); 
                statusEl.className = 'mt-3 text-sm text-error-red';
                statusEl.textContent = 'Action failed: Database not connected or not Admin.';
                return; 
            }

            const title = document.getElementById('new-news-title').value;
            const content = document.getElementById('new-news-content').value;

            if (!title || !content) {
                console.error("Title and Content are required for news.");
                statusEl.className = 'mt-3 text-sm text-error-red';
                statusEl.textContent = 'Title and Content are required.';
                return;
            }

            statusEl.className = 'mt-3 text-sm text-blue-600';
            statusEl.textContent = 'Publishing...';
            
            const newNews = { 
                title, 
                content, 
                timestamp: Date.now() 
            };
            
            try {
                await addDoc(collection(db, PUBLIC_NEWS_COLLECTION_PATH), newNews);
                
                document.getElementById('new-news-title').value = '';
                document.getElementById('new-news-content').value = '';
                
                statusEl.className = 'mt-3 text-sm text-green-600';
                statusEl.textContent = 'News published successfully!';
                
                setTimeout(toggleAddNewsForm, 1000); 

            } catch(e) {
                console.error("Error publishing news:", e);
                statusEl.className = 'mt-3 text-sm text-error-red';
                statusEl.textContent = `Publishing Failed. Error: ${e.message}`;
            }
        }

        window.deleteNews = async function(id) {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            try {
                await deleteDoc(doc(db, PUBLIC_NEWS_COLLECTION_PATH, id));
                console.log(`News ID: ${id} deleted successfully.`);
            } catch (error) {
                console.error("Error deleting news document:", error);
            }
        }

        window.saveNewsEntry = async function(id) {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            const newsItemEl = document.getElementById(`news-item-${id}`);
            const updatedData = {
                title: newsItemEl.querySelector(`#edit-news-title-${id}`).value,
                content: newsItemEl.querySelector(`#edit-news-content-${id}`).value,
            };

            try {
                await setDoc(doc(db, PUBLIC_NEWS_COLLECTION_PATH, id), updatedData, { merge: true });
                toggleNewsEdit(id); 
            } catch(e) {
                console.error("Error saving news entry:", e);
            }
        }

        // NEW: Partner functions
        window.addPartner = async function() {
            const statusEl = document.getElementById('partner-status-message');
            statusEl.textContent = ''; 

            if (!isAdmin || !db) { 
                statusEl.className = 'mt-3 text-sm text-error-red';
                statusEl.textContent = 'Action failed: Must be Admin.';
                return; 
            }

            const name = document.getElementById('new-partner-name').value;
            const logoUrl = document.getElementById('new-partner-logo').value;
            const url = document.getElementById('new-partner-url').value;
            const description = document.getElementById('new-partner-description').value;

            if (!name || !url) {
                statusEl.className = 'mt-3 text-sm text-error-red';
                statusEl.textContent = 'Partner Name and Website URL are required.';
                return;
            }

            statusEl.className = 'mt-3 text-sm text-blue-600';
            statusEl.textContent = 'Saving partner...';
            
            const newPartner = { name, logoUrl, url, description };
            
            try {
                await addDoc(collection(db, PUBLIC_PARTNERS_COLLECTION_PATH), newPartner);
                
                document.getElementById('new-partner-name').value = '';
                document.getElementById('new-partner-logo').value = '';
                document.getElementById('new-partner-url').value = '';
                document.getElementById('new-partner-description').value = '';
                
                statusEl.className = 'mt-3 text-sm text-green-600';
                statusEl.textContent = 'Partner saved successfully!';
                
                setTimeout(toggleAddPartnerForm, 1000); 

            } catch(e) {
                console.error("Error saving partner:", e);
                statusEl.className = 'mt-3 text-sm text-error-red';
                statusEl.textContent = `Saving Failed. Error: ${e.message}`;
            }
        }

        window.deletePartner = async function(id) {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            try {
                await deleteDoc(doc(db, PUBLIC_PARTNERS_COLLECTION_PATH, id));
                console.log(`Partner ID: ${id} deleted successfully.`);
            } catch (error) {
                console.error("Error deleting partner document:", error);
            }
        }

        window.savePartnerEntry = async function(id) {
            if (!isAdmin || !db) { console.error("Permission or DB denied."); return; }
            const partnerItemEl = document.getElementById(`partner-item-${id}`);
            const updatedData = {
                name: partnerItemEl.querySelector(`#edit-partner-name-${id}`).value,
                logoUrl: partnerItemEl.querySelector(`#edit-partner-logo-${id}`).value,
                url: partnerItemEl.querySelector(`#edit-partner-url-${id}`).value,
                description: partnerItemEl.querySelector(`#edit-partner-description-${id}`).value,
            };

            try {
                await setDoc(doc(db, PUBLIC_PARTNERS_COLLECTION_PATH, id), updatedData, { merge: true });
                togglePartnerEdit(id); 
            } catch(e) {
                console.error("Error saving partner entry:", e);
            }
        }
        
        // --- UI CONTROL FUNCTIONS ---
        
        window.toggleSocialEdit = function() {
            isEditingSocial = !isEditingSocial;
            renderApp();
        }

        window.toggleAboutEdit = function() {
            isEditingAbout = !isEditingAbout;
            renderApp();
        }

        window.toggleAddMusicForm = function() {
            const form = document.getElementById('add-music-form');
            form.classList.toggle('hidden');
        }

        window.toggleMusicEdit = function(id) {
            musicData = musicData.map(track => {
                const isTarget = track.id === id;
                return isTarget 
                    ? { ...track, isEditing: !track.isEditing } 
                    : { ...track, isEditing: false };
            });
            renderApp();
        }

        window.toggleAddNewsForm = function() {
            const form = document.getElementById('add-news-form');
            form.classList.toggle('hidden');
            document.getElementById('news-status-message').textContent = '';
        }

        window.toggleNewsEdit = function(id) {
            newsData = newsData.map(item => {
                 const isTarget = item.id === id;
                return isTarget 
                    ? { ...item, isEditing: !item.isEditing } 
                    : { ...item, isEditing: false };
            });
            renderApp();
        }
        
        window.toggleAddPartnerForm = function() {
            const form = document.getElementById('add-partner-form');
            form.classList.toggle('hidden');
            document.getElementById('partner-status-message').textContent = '';
        }

        window.togglePartnerEdit = function(id) {
            partnersData = partnersData.map(item => {
                 const isTarget = item.id === id;
                return isTarget 
                    ? { ...item, isEditing: !item.isEditing } 
                    : { ...item, isEditing: false };
            });
            renderApp();
        }

        // --- RENDERING FUNCTIONS ---
        
        function renderHeader() {
            const links = configData;
            
            const socialLinksHTML = `
                <div id="social-links-area" class="flex space-x-6">
                    <a href="${links.youtube}" target="_blank" class="text-text-dark hover:text-red-600 transition duration-300 transform hover:scale-110" aria-label="YouTube Channel">
                        <i class="fab fa-youtube text-2xl"></i>
                    </a>
                    <a href="${links.spotify}" target="_blank" class="text-text-dark hover:text-green-600 transition duration-300 transform hover:scale-110" aria-label="Spotify Profile">
                        <i class="fab fa-spotify text-2xl"></i>
                    </a>
                    <a href="${links.facebook}" target="_blank" class="text-text-dark hover:text-blue-700 transition duration-300 transform hover:scale-110" aria-label="Facebook Page">
                        <i class="fab fa-facebook-f text-2xl"></i>
                    </a>
                    <a href="${links.discord}" target="_blank" class="text-text-dark hover:text-indigo-600 transition duration-300 transform hover:scale-110" aria-label="Discord Server">
                        <i class="fab fa-discord text-2xl"></i>
                    </a>
                    ${isAdmin ? `<button onclick="toggleSocialEdit()" class="ml-4 text-sm text-accent-coffee hover:text-accent-light transition"><i class="fas fa-cog"></i></button>` : ''}
                </div>
            `;
            
            let headerContent = `
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
                    <a href="#" class="text-3xl font-extrabold text-accent-coffee tracking-wider mb-4 md:mb-0">
                        JinSun <span class="text-text-dark font-light">Official</span>
                    </a>
                    
                    ${socialLinksHTML}
                </div>
            `;

            if (isAdmin && isEditingSocial) {
                headerContent = `
                    <div class="max-w-7xl mx-auto p-4 bg-background-cream rounded-xl shadow-lg border border-accent-coffee/50">
                        <h3 class="text-xl font-bold mb-3 text-accent-coffee">Edit Social Links (Admin)</h3>
                        <div class="space-y-2">
                            <input id="youtube-link-input" type="url" value="${links.youtube}" placeholder="YouTube URL" class="w-full p-2 border rounded-lg text-text-dark">
                            <input id="spotify-link-input" type="url" value="${links.spotify}" placeholder="Spotify URL" class="w-full p-2 border rounded-lg text-text-dark">
                            <input id="facebook-link-input" type="url" value="${links.facebook}" placeholder="Facebook URL" class="w-full p-2 border rounded-lg text-text-dark">
                            <input id="discord-link-input" type="url" value="${links.discord}" placeholder="Discord Server URL" class="w-full p-2 border rounded-lg text-text-dark">
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="saveSocialLinks()" class="px-4 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                                <i class="fas fa-save mr-1"></i> Save Links
                            </button>
                            <button onclick="toggleSocialEdit()" class="px-4 py-2 bg-gray-300 text-text-dark font-semibold rounded-lg hover:bg-gray-400 transition">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('header-container').innerHTML = headerContent;
            
            document.getElementById('edit-about-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('add-music-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('add-news-btn')?.classList.toggle('hidden', !isAdmin);
            document.getElementById('add-partner-btn')?.classList.toggle('hidden', !isAdmin);
        }

        function renderError(message) {
             document.getElementById('music-list').innerHTML = `<div class="col-span-full flex justify-center items-center p-10 text-xl text-error-red">${message}</div>`;
             document.getElementById('news-list').innerHTML = `<div class="flex justify-start items-center p-4 text-xl text-error-red">${message}</div>`;
             document.getElementById('partners-list').innerHTML = `<div class="col-span-full flex justify-center items-center p-4 text-xl text-error-red">${message}</div>`;
             
             const aboutEl = document.getElementById('about-content');
             if(aboutEl) aboutEl.innerHTML = `<p class="text-error-red p-2">${message}</p>`;
             
             const authEl = document.getElementById('auth-ui');
             if(authEl) authEl.innerHTML = `
                    <div class="flex justify-center items-center h-16 text-gray-500 text-md">
                        <i class="fas fa-exclamation-triangle mr-3 text-error-red"></i> ${message}
                    </div>
                `;
        }


        function renderAboutMe() {
            const aboutContentEl = document.getElementById('about-content');
            
            // Check if Firebase is initialized or if auth is still pending
            if (!isAuthReady) {
                 aboutContentEl.innerHTML = `<div class="flex justify-center items-center h-24 text-gray-500 text-lg"><i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading...</div>`;
                 return; 
            }
            
            // If Firebase failed to initialize
            if (!auth) { 
                aboutContentEl.innerHTML = `<div class="flex justify-center items-center h-24 text-gray-500 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-error-red"></i> Database not connected. Check console for configuration errors.</div>`;
                return;
            }

            
            if (isAdmin && isEditingAbout) {
                aboutContentEl.innerHTML = `
                    <textarea id="about-edit-textarea" rows="8" class="w-full p-3 border border-gray-300 rounded-lg text-text-dark focus:ring-accent-coffee focus:border-accent-coffee">${configData.about}</textarea>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="saveAboutMe()" class="px-4 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                            <i class="fas fa-save mr-1"></i> Save Changes
                        </button>
                        <button onclick="toggleAboutEdit()" class="px-4 py-2 bg-gray-300 text-text-dark font-semibold rounded-lg hover:bg-gray-400 transition">
                            <i class="fas fa-times mr-1"></i> Cancel
                        </button>
                    </div>
                `;
            } else {
                aboutContentEl.innerHTML = `
                    <p class="max-w-4xl text-text-dark/80 text-lg leading-relaxed">${configData.about}</p>
                `;
            }
        }

        function renderMusic() {
            const musicListEl = document.getElementById('music-list');
            
            if (!isAuthReady) {
                musicListEl.innerHTML = `<div class="col-span-full flex justify-center items-center p-10 h-24 text-gray-500 text-lg"><i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading Music...</div>`;
                return;
            }

            if (!auth) {
                musicListEl.innerHTML = `<div class="col-span-full flex justify-center items-center p-10 h-24 text-gray-500 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-error-red"></i> Database not connected.</div>`;
                return;
            }

            if (musicData.length === 0) {
                musicListEl.innerHTML = `<div class="col-span-full flex justify-center items-center p-10 h-24 text-xl text-gray-500">${isAdmin ? 'No music tracks found. Click "Add Track" above to start.' : 'No music available yet.'}</div>`;
                return;
            }

            musicListEl.innerHTML = musicData.map(track => {
                // If in edit mode (only admin can edit)
                if (track.isEditing && isAdmin) {
                    return `
                        <div id="music-card-${track.id}" class="bg-card-light shadow-lg rounded-xl p-6 border-2 border-accent-coffee/50">
                            <p class="text-xs text-gray-500 mb-2">ID: ${track.id}</p>
                            <h3 class="text-2xl font-bold mb-1 text-accent-coffee">
                                <input id="edit-title-${track.id}" type="text" value="${track.title}" class="w-full p-1 border rounded text-text-dark">
                            </h3>
                            <div class="flex space-x-2 text-text-dark/70 text-sm mb-3">
                                <input id="edit-year-${track.id}" type="text" value="${track.year}" class="w-1/3 p-1 border rounded text-text-dark">
                                <input id="edit-type-${track.id}" type="text" value="${track.type}" class="w-2/3 p-1 border rounded text-text-dark">
                            </div>
                            <textarea id="edit-description-${track.id}" rows="3" class="w-full p-1 mb-3 border rounded text-text-dark">${track.description}</textarea>
                            <input id="edit-url-${track.id}" type="url" value="${track.url}" placeholder="Listen URL" class="w-full p-1 mb-4 border rounded text-text-dark">
                            
                            <div class="flex space-x-2">
                                <button onclick="saveMusicEntry('${track.id}')" class="flex-grow px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-check mr-2"></i> Save
                                </button>
                                <button onclick="toggleMusicEdit('${track.id}')" class="px-4 py-2 bg-gray-300 text-text-dark font-semibold rounded-lg hover:bg-gray-400 transition">
                                    <i class="fas fa-times mr-2"></i> Cancel
                                </button>
                            </div>
                        </div>
                    `;
                }

                // If in view mode (public or logged in non-admin)
                return `
                    <div id="music-card-${track.id}" class="bg-card-light shadow-lg rounded-xl p-6 transition duration-300 hover:shadow-accent-coffee/30 hover:shadow-2xl border border-gray-200">
                        <h3 class="text-2xl font-bold mb-1 text-accent-coffee">${track.title}</h3>
                        <p class="text-text-dark/70 text-sm mb-4">${track.year} • ${track.type}</p>
                        <p class="text-text-dark/90 mb-4">${track.description || 'No description provided.'}</p>
                        
                        ${track.url ? `
                            <a href="${track.url}" target="_blank" class="block w-full text-center px-4 py-3 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition transform hover:scale-[1.02]">
                                <i class="fas fa-headphones mr-2"></i> Listen Now
                            </a>
                        ` : `
                            <button class="w-full px-4 py-3 bg-gray-200 text-gray-500 font-semibold rounded-lg cursor-not-allowed">
                                Link Coming Soon
                            </button>
                        `}

                        ${isAdmin ? `
                            <div class="mt-4 flex space-x-2">
                                <button onclick="toggleMusicEdit('${track.id}')" class="flex-grow px-3 py-1 bg-gray-100 text-text-dark rounded-lg hover:bg-gray-200 transition">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button onclick="deleteMusic('${track.id}')" class="px-3 py-1 bg-error-red text-white rounded-lg hover:bg-red-700 transition">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // RENDER FUNCTION FOR NEWS
        function renderNews() {
            const newsListEl = document.getElementById('news-list');

            if (!isAuthReady) {
                newsListEl.innerHTML = `<div class="flex justify-start items-center p-4 h-24 text-gray-500 text-lg"><i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading News...</div>`;
                return;
            }

            if (!auth) {
                newsListEl.innerHTML = `<div class="flex justify-start items-center p-4 h-24 text-gray-500 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-error-red"></i> Database not connected.</div>`;
                return;
            }
            
            if (newsData.length === 0) {
                const content = isAdmin ? 'No news items found. Click "Add News" above to publish one.' : 'No news available yet.';
                newsListEl.innerHTML = `<div class="flex justify-start items-center p-4 h-24 text-xl text-gray-500">${content}</div>`;
                return;
            }
            
            // Format timestamp for display
            const formatDate = (timestamp) => {
                if (!timestamp) return 'No Date';
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
            };

            newsListEl.innerHTML = newsData.map((item, index) => {
                const displayDate = formatDate(item.timestamp);
                // Determine border color based on index for variety
                const borderColor = index % 2 === 0 ? 'border-accent-coffee' : 'border-accent-light';

                // Admin Edit Mode
                if (item.isEditing && isAdmin) {
                    return `
                        <div id="news-item-${item.id}" class="bg-card-light shadow-lg p-6 rounded-xl border-l-4 ${borderColor} border-2 border-accent-coffee/50">
                            <p class="text-xs text-gray-500 mb-2">ID: ${item.id}</p>
                            <input id="edit-news-title-${item.id}" type="text" value="${item.title}" class="text-2xl font-bold mb-2 w-full p-2 border rounded-lg text-text-dark focus:ring-accent-coffee focus:border-accent-coffee">
                            <textarea id="edit-news-content-${item.id}" rows="4" class="w-full p-2 mb-3 border rounded-lg text-text-dark focus:ring-accent-coffee focus:border-accent-coffee">${item.content}</textarea>
                            
                            <div class="flex space-x-2">
                                <button onclick="saveNewsEntry('${item.id}')" class="flex-grow px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-check mr-2"></i> Save Changes
                                </button>
                                <button onclick="toggleNewsEdit('${item.id}')" class="px-4 py-2 bg-gray-300 text-text-dark font-semibold rounded-lg hover:bg-gray-400 transition">
                                    <i class="fas fa-times mr-2"></i> Cancel
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Public View Mode
                return `
                    <div id="news-item-${item.id}" class="bg-card-light shadow-md p-6 rounded-xl border-l-4 ${borderColor} transition duration-300 hover:shadow-accent-coffee/30 hover:shadow-2xl">
                        <p class="text-sm text-accent-light mb-1 font-semibold">${displayDate}</p>
                        <h3 class="text-2xl font-bold mb-2 text-text-dark">${item.title}</h3>
                        <p class="text-text-dark/80 leading-relaxed whitespace-pre-wrap">${item.content}</p>
                        ${isAdmin ? `
                            <div class="mt-4 flex space-x-2">
                                <button onclick="toggleNewsEdit('${item.id}')" class="flex-grow px-3 py-1 bg-gray-100 text-text-dark rounded-lg hover:bg-gray-200 transition">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button onclick="deleteNews('${item.id}')" class="px-3 py-1 bg-error-red text-white rounded-lg hover:bg-red-700 transition">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // RENDER FUNCTION FOR PARTNERS
        function renderPartners() {
            const partnersListEl = document.getElementById('partners-list');
            
            if (!isAuthReady) {
                partnersListEl.innerHTML = `<div class="col-span-full flex justify-center items-center p-4 h-24 text-gray-500 text-lg"><i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Loading Partners...</div>`;
                return;
            }

            if (!auth) {
                partnersListEl.innerHTML = `<div class="col-span-full flex justify-center items-center p-4 h-24 text-gray-500 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-error-red"></i> Database not connected.</div>`;
                return;
            }

            if (partnersData.length === 0) {
                const content = isAdmin ? 'No partners listed yet. Click "Add Partner" above to get started.' : 'No official partners to display yet.';
                partnersListEl.innerHTML = `<div class="col-span-full flex justify-center items-center p-4 h-24 text-xl text-gray-500">${content}</div>`;
                return;
            }

            partnersListEl.innerHTML = partnersData.map(partner => {
                // Admin Edit Mode
                if (partner.isEditing && isAdmin) {
                    return `
                        <div id="partner-item-${partner.id}" class="col-span-1 bg-card-light shadow-lg rounded-xl p-4 border-2 border-accent-coffee/50">
                            <p class="text-xs text-gray-500 mb-2">ID: ${partner.id}</p>
                            <input id="edit-partner-name-${partner.id}" type="text" value="${partner.name}" placeholder="Name" class="w-full p-1 border rounded text-text-dark mb-2 font-bold">
                            <input id="edit-partner-logo-${partner.id}" type="url" value="${partner.logoUrl || ''}" placeholder="Logo URL" class="w-full p-1 border rounded text-text-dark mb-2 text-sm">
                            <input id="edit-partner-url-${partner.id}" type="url" value="${partner.url}" placeholder="Website URL" class="w-full p-1 border rounded text-text-dark mb-2 text-sm">
                            <textarea id="edit-partner-description-${partner.id}" rows="2" placeholder="Description" class="w-full p-1 mb-3 border rounded text-text-dark text-sm">${partner.description || ''}</textarea>
                            
                            <div class="flex space-x-2">
                                <button onclick="savePartnerEntry('${partner.id}')" class="flex-grow px-3 py-1 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-check"></i> Save
                                </button>
                                <button onclick="togglePartnerEdit('${partner.id}')" class="px-3 py-1 bg-gray-300 text-text-dark text-sm font-semibold rounded-lg hover:bg-gray-400 transition">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Public View Mode
                const placeholder = `https://placehold.co/150x150/F8F4E3/A0522D?text=${partner.name.substring(0, 3).toUpperCase()}`;
                
                return `
                    <a href="${partner.url}" target="_blank" id="partner-item-${partner.id}" 
                        class="group bg-card-light shadow-md p-4 rounded-xl flex flex-col items-center justify-between border border-gray-200 transition duration-300 hover:shadow-xl hover:shadow-accent-light/30 transform hover:scale-[1.03]">
                        
                        <div class="partner-logo-container mb-3">
                            <img src="${partner.logoUrl || placeholder}" 
                                 alt="${partner.name} Logo" 
                                 class="partner-logo-image"
                                 onerror="this.onerror=null; this.src='${placeholder}';"
                            />
                        </div>

                        <h3 class="text-lg font-bold text-text-dark group-hover:text-accent-coffee">${partner.name}</h3>
                        <p class="text-xs text-text-dark/70 text-center mt-1 mb-3 h-8 overflow-hidden">${partner.description || 'Partnered for success.'}</p>
                        
                        <span class="text-xs text-accent-light font-semibold group-hover:underline">Visit Site <i class="fas fa-external-link-alt ml-1 text-[10px]"></i></span>

                        ${isAdmin ? `
                            <div class="mt-3 flex space-x-2 w-full">
                                <button onclick="event.preventDefault(); togglePartnerEdit('${partner.id}')" class="flex-grow px-2 py-1 bg-gray-100 text-text-dark text-xs rounded-lg hover:bg-gray-200 transition">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="event.preventDefault(); deletePartner('${partner.id}')" class="px-2 py-1 bg-error-red text-white text-xs rounded-lg hover:bg-red-700 transition">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        ` : ''}
                    </a>
                `;
            }).join('');
        }


        
        function renderAuthUI() {
            const authEl = document.getElementById('auth-ui');
            
            if (!isAuthReady) {
                 authEl.innerHTML = `
                    <div class="flex justify-center items-center h-16 text-gray-500 text-md">
                        <i class="fas fa-sync-alt animate-spin-slow mr-3"></i> Authenticating...
                    </div>
                `;
                return;
            }

            if (!auth) {
                 authEl.innerHTML = `
                    <div class="flex justify-center items-center h-16 text-gray-500 text-md">
                        <i class="fas fa-exclamation-triangle mr-3 text-error-red"></i> Authentication service unavailable.
                    </div>
                `;
                return;
            }


            const userEmail = currentUser?.email;
            
            if (userEmail) {
                // 1. Logged in member/admin (Show Profile/Logout)
                authEl.innerHTML = `
                    <p class="text-md font-semibold text-text-dark mb-2 flex items-center justify-center">
                        <i class="fas fa-user-circle mr-2 text-accent-coffee"></i> 
                        Welcome, ${isAdmin ? '<span class="text-error-red font-bold">(Admin)</span> ' : 'Member '} ${userEmail}
                    </p>
                    <button onclick="handleSignOut()" class="px-4 py-2 bg-gray-300 text-text-dark font-semibold rounded-lg hover:bg-gray-400 transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Sign Out
                    </button>
                    <p id="auth-status" class="text-sm mt-2 text-green-600"></p>
                `;
            // Only show the "Browsing as Guest" prompt if we are anonymous AND the user hasn't tried to log in yet.
            } else if (auth.currentUser && auth.currentUser.isAnonymous && currentAuthMode === 'guest_prompt') {
                 // 2. Guest Browsing Mode (Show Button to toggle to Form)
                 authEl.innerHTML = `
                    <p class="text-md font-semibold text-text-dark mb-2">
                        <i class="fas fa-user-circle mr-2 text-accent-coffee"></i> 
                        Browsing as Guest.
                    </p>
                     <button onclick="toggleAuthMode('login')" class="px-4 py-2 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                        <i class="fas fa-sign-in-alt mr-1"></i> Login / Sign Up
                    </button>
                    <p id="auth-status" class="text-sm mt-2 text-green-600"></p>
                `;
            } else {
                // 3. Login/Signup Form 
                const isLogin = currentAuthMode === 'login';
                
                authEl.innerHTML = `
                    <h3 class="text-lg font-bold mb-3 text-accent-coffee">${isLogin ? 'Member Login' : 'Create Account'}</h3>
                    <div class="space-y-3">
                        <input type="email" id="auth-email-input" placeholder="Email Address" class="w-full p-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                        <input type="password" id="auth-password-input" placeholder="Password (min 6 characters)" class="w-full p-3 border rounded-lg focus:ring-accent-coffee focus:border-accent-coffee text-text-dark">
                    </div>
                    <div class="mt-4 flex flex-col space-y-2">
                        <button onclick="${isLogin ? 'handleSignIn()' : 'handleSignUp()'}" class="px-5 py-3 bg-accent-coffee text-white font-semibold rounded-lg hover-darken transition">
                            <i class="fas ${isLogin ? 'fa-sign-in-alt' : 'fa-user-plus'} mr-2"></i> 
                            ${isLogin ? 'Sign In' : 'Sign Up'}
                        </button>
                        <button onclick="toggleAuthMode('${isLogin ? 'signup' : 'login'}')" class="text-sm text-accent-coffee hover:underline">
                            ${isLogin ? 'Need an account? Sign Up' : 'Already have an account? Login'}
                        </button>
                    </div>
                    <p id="auth-status" class="text-sm mt-2 text-error-red"></p>
                `;
            }
        }

        // --- MASTER RENDER FUNCTION ---
        function renderApp() {
            renderHeader();
            renderAboutMe();
            renderMusic();
            renderNews(); 
            renderPartners(); 
            renderAuthUI(); 
        }
    </script>

</body>
</html>	
